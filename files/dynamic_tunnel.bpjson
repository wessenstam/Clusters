{"status":{},"contains_secrets":false,"product_version":"3.0.6","spec":{"description":"","resources":{"client_attrs":{"66f4661a_deployment":{"y":140,"x":395.5}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"547dcdb2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"32a98faa_runbook","main_task_local_reference":{"kind":"app_task","name":"547dcdb2_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5f60d5bf_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e211f5bb_runbook","main_task_local_reference":{"kind":"app_task","name":"5f60d5bf_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a047ec90_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"29b78a31_runbook","main_task_local_reference":{"kind":"app_task","name":"a047ec90_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"81ebf60e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0f72aefa_runbook","main_task_local_reference":{"kind":"app_task","name":"81ebf60e_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6f3cc0e8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8a2c12fd_runbook","main_task_local_reference":{"kind":"app_task","name":"6f3cc0e8_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service1","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"VM1","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"AWStunnel-@@{calm_application_name}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"ca120242-0b19-4478-b427-9dca2328634e"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nssh_pwauth: true\n\nusers:   \n  - name: centos\n    chpasswd: { expire: False }\n    lock-passwd: false\n    plain_text_passwd: 'nutanix\/4u'\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\n    \nruncmd:\n  - setenforce 0\n  - sed -i s\/^SELINUX=.*$\/SELINUX=disabled\/ \/etc\/selinux\/config\n  - systemctl disable firewalld\n  - systemctl stop firewalld\n  - yum -y install lvm2"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"445eece8-3e88-4d53-be91-0fea5d474530","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS-7-cloud","uuid":"3e07b064-8eec-4044-a6a2-e7c4dfb5914c"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"centos"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service1"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Forward IP Traffic"},{"kind":"app_task","name":"install_strongSwan"}],"name":"d3dc92d1_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Forward IP Traffic"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"install_strongSwan"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Forward IP Traffic","attrs":{"exit_status":[],"script":"#!\/bin\/bash\necho \"\nnet.ipv4.ip_forward = 1\nnet.ipv4.conf.all.accept_redirects = 0\nnet.ipv4.conf.all.send_redirects = 0\" | sudo tee \/etc\/sysctl.conf\n\nsudo sysctl -p","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"install_strongSwan","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Get the needed parameters\n\nonprem_netw=\"@@{on_prem_netw}@@\/@@{on_prem_mask}@@\"\naws_vpc_netw=\"@@{aws_vpc_net}@@\/@@{aws_vpc_mask}@@\"\n\nlocal_IP=$(sudo ifconfig eth0 | grep netmask | awk '{print $2}')\ncgw_ipaddress=$(curl --insecure --silent https:\/\/myexternalip.com | grep \"<title>\" | tr -s \" \" \":\" | cut -d \":\" -f 7)\necho \"this is my external IP address, please use it as customer gateway on AWS side\" $cgw_ipaddress\necho \"once created tunnel, please copy vpn_file.txt on this machine, under \/tmp folder with name vpn_file.txt\"\necho \"IPaddress to ssh to me is the following: \" $local_IP\n\n\n# Install the strongswan package\nsudo yum install -y -q epel-release wget\nsudo yum update -y -q\nsudo yum install -y -q strongswan\n\nuntil [ -f \/tmp\/vpn_file.txt ]\ndo\n     sleep 30\n     date     \ndone\n\ngrep \"Pre-Shared\" \/tmp\/vpn_file.txt | grep -v Auth | awk '{print $5}' > ~\/info.txt\ngrep \"Customer Gateway\" \/tmp\/vpn_file.txt | grep \":\" | grep -vwE \"(ASN|your|ID)\" | awk '{print $5}' >> ~\/info.txt\ngrep \"Virtual Private Gateway\" \/tmp\/vpn_file.txt | grep \":\" | grep -v ID | awk '{print $6}' >> ~\/info.txt\n\npsk_tun1_aws=$(sed '1q;d' ~\/info.txt)\npsk_tun2_aws=$(sed '2q;d' ~\/info.txt)\npublic_cgw=$(sed '3q;d' ~\/info.txt)\nvpn_tun1_netwl=$(sed '4q;d' ~\/info.txt)\nvpn_tun2_netwl=$(sed '6q;d' ~\/info.txt)\naws_vgw1=$(sed '7q;d' ~\/info.txt)\nvpn_tun1_netwr=$(sed '8q;d' ~\/info.txt)\naws_vgw2=$(sed '9q;d' ~\/info.txt)\nvpn_tun2_netwr=$(sed '10q;d' ~\/info.txt)\n\nrm ~\/info.txt\n\necho \"\nconfig setup\n\tstrictcrlpolicy=no\n\tuniqueids = no\n\nconn Tunnel1\n\tauto=start\n\tleftid=${public_cgw}\n\tright=${aws_vgw1}\n\ttype=tunnel\n\tleftauth=psk\n\trightauth=psk\n\tkeyexchange=ikev1\n\tike=aes128-sha1-modp1024\n\tikelifetime=8h\n\tesp=aes128-sha1-modp1024\n\tlifetime=1h\n\tkeyingtries=%forever\n\tleftsubnet=${onprem_netw}\n\trightsubnet=${aws_vpc_netw}\n\tdpddelay=10s\n\tdpdtimeout=30s\n\tdpdaction=restart\n\tmark=100\n\tleftupdown=\\\"\/etc\/strongswan\/aws-updown.sh -ln Tunnel1 -ll ${vpn_tun1_netwl} -lr ${vpn_tun1_netwr} -m 100 -r ${aws_vpc_netw}\\\"\n\nconn Tunnel2\n\tauto=start\n\tleftid=${public_cgw}\n\tright=${aws_vgw2}\n\ttype=tunnel\n\tleftauth=psk\n\trightauth=psk\n\tkeyexchange=ikev1\n\tike=aes128-sha1-modp1024\n\tikelifetime=8h\n\tesp=aes128-sha1-modp1024\n\tlifetime=1h\n\tkeyingtries=%forever\n\tleftsubnet=${onprem_netw}\n\trightsubnet=${aws_vpc_netw}\n\tdpddelay=10s\n\tdpdtimeout=30s\n\tdpdaction=restart\n\tmark=200\n\tleftupdown=\\\"\/etc\/strongswan\/aws-updown.sh -ln Tunnel2 -ll ${vpn_tun2_netwl} -lr ${vpn_tun2_netwr} -m 200 -r ${aws_vpc_netw}\\\" \" | sudo tee \/etc\/strongswan\/ipsec.conf\n\n# Create the ipsec.secrets files\necho \"${public_cgw} ${aws_vgw1} : PSK \\\"${psk_tun1_aws}\\\"\n${public_cgw} ${aws_vgw2} : PSK \\\"${psk_tun2_aws}\\\"\" | sudo tee \/etc\/strongswan\/ipsec.secrets\n\n\n# Get the aws-updown.sh script and make executable\nsudo wget -q https:\/\/raw.githubusercontent.com\/wessenstam\/Clusters\/master\/files\/aws-updown.sh -O \/etc\/strongswan\/aws-updown.sh\nsudo chmod +x \/etc\/strongswan\/aws-updown.sh\n\n# Make sure strongswan starts at boot time\nsudo chkconfig --level 35 strongswan on\n\n# start strongswan\nsudo strongswan start","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"20028498_runbook","main_task_local_reference":{"kind":"app_task","name":"d3dc92d1_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f105467d_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a7622703_runbook","main_task_local_reference":{"kind":"app_task","name":"f105467d_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"66f4661a_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"aws_vpc_mask","value":"16","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"aws_vpc_net","value":"10.10.0.0","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"on_prem_mask","value":"24","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"on_prem_netw","value":"10.42.7.0","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"centos"},"type":"USER"},"name":"dynamic_tunnel"},"api_version":"3.0","metadata":{"last_update_time":"1601636476329498","kind":"blueprint","spec_version":20,"creation_time":"1601480048635526","name":"dynamic_tunnel"}}